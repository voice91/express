/**
 * This file is generated by Appinvento, also it can be overwritten by Appinvento.
 * Only fields name will be overwritten, if the field name will be changed.
 */
import ApiError from 'utils/ApiError';
import httpStatus from 'http-status';
import { Deal, User } from 'models';

export async function getDealById(id, options = {}) {
  const deal = await Deal.findById(id, options.projection, options);
  return deal;
}

export async function getOne(query, options = {}) {
  const deal = await Deal.findOne(query, options.projection, options);
  return deal;
}

export async function getDealList(filter, options = {}) {
  const deal = await Deal.find(filter, options.projection, options);
  return deal;
}

export async function getDealListWithPagination(filter, options = {}) {
  const deal = await Deal.paginate(filter, options);
  return deal;
}

export async function createDeal(body) {
  if (body.involvedUsers.advisors) {
    const advisorsArr = body.involvedUsers.advisors.map((item) => item);

    const advisors = await User.find({ _id: { $in: advisorsArr } });
    if (advisors.length !== advisorsArr.length) {
      throw new ApiError(httpStatus.BAD_REQUEST, 'advisors not found!');
    }
  } else if (body.involvedUsers.lenders) {
    const lendersArr = body.involvedUsers.lenders.map((item) => item);
    const lenders = await User.find({ _id: { $in: lendersArr } });
    if (lenders.length !== lendersArr.length) {
      throw new ApiError(httpStatus.BAD_REQUEST, 'lenders not found!');
    }
  } else {
    const borrowersArr = body.involvedUsers.borrowers.map((item) => item);
    const borrowers = await User.find({ _id: { $in: borrowersArr } });
    if (borrowers.length !== borrowersArr.length) {
      throw new ApiError(httpStatus.BAD_REQUEST, 'borrowers not found!');
    }
  }
  const deal = await Deal.create(body);
  return deal;
}
export async function updateDeal(filter, body, options = {}) {
  if (body.involvedUsers.advisors) {
    const advisorsArr = body.involvedUsers.advisors.map((item) => item);

    const advisors = await User.find({ _id: { $in: advisorsArr } });
    if (advisors.length !== advisorsArr.length) {
      throw new ApiError(httpStatus.BAD_REQUEST, 'advisors not found!');
    }
  } else if (body.involvedUsers.lenders) {
    const lendersArr = body.involvedUsers.lenders.map((item) => item);
    const lenders = await User.find({ _id: { $in: lendersArr } });
    if (lenders.length !== lendersArr.length) {
      throw new ApiError(httpStatus.BAD_REQUEST, 'lenders not found!');
    }
  } else {
    const borrowersArr = body.involvedUsers.borrowers.map((item) => item);
    const borrowers = await User.find({ _id: { $in: borrowersArr } });
    if (borrowers.length !== borrowersArr.length) {
      throw new ApiError(httpStatus.BAD_REQUEST, 'borrowers not found!');
    }
  }
  const deal = await Deal.findOneAndUpdate(filter, body, options);
  return deal;
}

export async function updateManyDeal(filter, body, options = {}) {
  const deal = await Deal.updateMany(filter, body, options);
  return deal;
}

export async function removeDeal(filter) {
  const deal = await Deal.findOneAndRemove(filter);
  return deal;
}

export async function removeManyDeal(filter) {
  const deal = await Deal.deleteMany(filter);
  return deal;
}
